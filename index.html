<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Calendrier</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;600&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg: radial-gradient(circle at 20% 20%, #f8f3ff 0, #f3f8ff 45%, #eef7f5 100%);
      --card:#ffffff;
      --text:#1f2b3a;
      --muted:#6b7b8c;
      --accent:#2f80ed;
      --grid:#dce4ef;
      --sidebar-space:132px;
      --sidebar-gap:12px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      min-height:100vh;
      display:flex;
      align-items:center;
      justify-content:center;
      background:var(--bg);
      color:var(--text);
      font-family:"DM Sans","Avenir Next","Segoe UI",sans-serif;
    }
    .wrap{ width:min(960px,94vw); }
    @media (min-width: 1201px){
      .wrap{
        width:calc(min(960px,94vw) + var(--sidebar-space));
        padding-left:var(--sidebar-space);
      }
    }
    header{ text-align:center; margin-bottom:18px; }
    h1{
      margin:0;
      font-weight:600;
      font-size:clamp(26px,4vw,34px);
      letter-spacing:.4px;
    }
    p.subtitle{
      margin:8px 0 0;
      color:var(--muted);
      font-size:15px;
    }
    .month-controls{
      display:flex;
      gap:8px;
      align-items:center;
      justify-content:center;
      flex-wrap:wrap;
      margin-top:12px;
    }
    .month-select,.year-select{
      border:1px solid var(--grid);
      border-radius:10px;
      padding:9px 10px;
      background:#fff;
      font-weight:700;
      cursor:pointer;
      min-width:120px;
    }

    .calendar{
      background:var(--card);
      border-radius:14px;
      box-shadow:0 14px 40px rgba(15,23,42,.10);
      padding:18px 18px 10px;
      overflow:visible;
    }
    .calendar-shell{
      position:relative;
      margin-top:6px;
    }
    .view-side{
      position:absolute;
      right:calc(100% + var(--sidebar-gap));
      top:14px;
      display:flex;
      flex-direction:column;
      gap:8px;
      align-items:stretch;
    }
    .view-side .view-btn{
      min-width:110px;
      padding:8px 10px;
      font-size:13px;
      justify-content:center;
    }

    .grid{
      display:grid;
      grid-template-columns:repeat(7,1fr);
      gap:8px;
      padding:8px;
    }
    .day-name{
      text-align:center;
      font-weight:600;
      color:var(--muted);
      font-size:13px;
      text-transform:uppercase;
      letter-spacing:.6px;
    }
    .date{
      position:relative;
      border:1px solid var(--grid);
      border-radius:10px;
      min-height:96px;
      padding:12px 8px 32px;
      background:#fdfefe;
      font-weight:600;
      font-size:16px;
      display:flex;
      align-items:flex-start;
      justify-content:flex-end;
      color:var(--text);
      transition:transform 120ms ease, box-shadow 120ms ease;
      overflow:visible;
    }
    .date:hover{
      transform:translateY(-2px);
      box-shadow:0 10px 24px rgba(15,23,42,.08);
    }
    .empty{ visibility:hidden; }
    .special{ color:var(--accent); }

    .legend{
      display:flex;
      gap:12px;
      align-items:center;
      padding:8px 10px 14px;
      color:var(--muted);
      font-size:13px;
    }
    .legend span{
      display:inline-flex;
      align-items:center;
      gap:6px;
    }
    .dot{
      width:10px;height:10px;
      background:var(--accent);
      border-radius:50%;
      display:inline-block;
    }

    .density-med{
      background:linear-gradient(180deg,#eef5ff 0%,#ffffff 100%);
      border-color:#c7d9f3;
    }
    .density-high{
      background:linear-gradient(180deg,#ffecec 0%,#ffffff 100%);
      border-color:#f2c4c4;
    }

    .add-btn{
      position:absolute;
      top:6px; left:6px;
      width:32px; height:32px;
      border:1px solid var(--grid);
      border-radius:6px;
      background:#fff;
      color:var(--accent);
      font-weight:700;
      font-size:14px;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      transition:transform 120ms ease, box-shadow 120ms ease, color 120ms ease;
    }
    .add-btn:hover{
      transform:translateY(-1px);
      box-shadow:0 8px 16px rgba(15,23,42,.08);
      color:#185ec4;
    }
    .name-plus-wrap{
      display:flex;
      align-items:center;
      gap:8px;
    }
    .plus-wrap{
      position:relative;
      display:inline-flex;
      align-items:center;
      justify-content:center;
    }
    .name-plus-btn{
      width:32px;
      height:32px;
      border:1px solid var(--grid);
      border-radius:8px;
      background:#eef4ff;
      cursor:pointer;
      font-weight:800;
      color:var(--text);
    }
    .name-dropdown{
      position:absolute;
      top:50%;
      left:calc(100% + 8px);
      transform:translateY(-50%);
      min-width:180px;
      max-width:240px;
      max-height:220px;
      overflow-y:auto;
      background:#fff;
      border:1px solid var(--grid);
      border-radius:10px;
      box-shadow:0 14px 30px rgba(15,23,42,.16);
      padding:6px;
      display:flex;
      flex-direction:column;
      gap:4px;
      z-index:50;
    }
    .name-dropdown[hidden]{ display:none; }
    .name-option{
      border:none;
      background:#f9fbff;
      border-radius:8px;
      padding:8px 10px;
      text-align:left;
      cursor:pointer;
      font-weight:700;
      color:var(--text);
    }
    .name-option:hover{
      background:#eef4ff;
    }
    .name-empty{
      color:var(--muted);
      font-size:12px;
      padding:8px 10px;
    }
    .day-number{
      position:absolute;
      top:8px; right:8px;
      font-size:16px;
    }
    .initials{
      position:absolute;
      bottom:8px; right:8px;
      display:flex;
      gap:4px;
      row-gap:2px;
      flex-wrap:wrap;
      justify-content:flex-end;
      max-width:calc(100% - 40px);
      max-height:64px;
      overflow-y:auto;
      padding-right:2px;
    }
    .initial{
      min-width:24px;
      height:22px;
      padding:0 6px;
      border-radius:6px;
      background:rgba(47,128,237,.12);
      color:var(--text);
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:2px;
      font-size:12px;
      font-weight:700;
      line-height:1;
    }
    .initial-second{ font-size:10px; opacity:.8; }

    .modal-overlay{
      position:fixed;
      inset:0;
      background:rgba(15,23,42,.35);
      display:none;
      align-items:center;
      justify-content:center;
      padding:20px;
      z-index:20;
    }
    .modal{
      background:#fff;
      border-radius:14px;
      box-shadow:0 16px 48px rgba(15,23,42,.18);
      width:min(520px,94vw);
      padding:18px;
    }
    .modal-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:12px;
    }
    .modal-title{
      margin:0;
      font-size:18px;
      font-weight:600;
      color:var(--text);
    }
    .close-btn{
      border:none;
      background:transparent;
      font-size:18px;
      cursor:pointer;
      color:var(--muted);
    }
    .name-list{
      margin-top:12px;
      display:flex;
      flex-direction:column;
      gap:10px;
      max-height:320px;
      overflow-y:auto;
      padding-right:6px;
    }
    .name-row{
      border:1px solid var(--grid);
      border-radius:10px;
      padding:10px;
      display:flex;
      flex-direction:column;
      gap:8px;
      position:relative;
    }
    .name-header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:8px;
    }
    .name-text{ font-weight:600; color:var(--text); }
    .icon-actions{
      display:inline-flex;
      gap:6px;
      align-items:center;
    }
    .edit-btn,.delete-btn{
      border:1px solid var(--grid);
      border-radius:8px;
      width:36px;height:36px;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      cursor:pointer;
      font-size:16px;
      transition:transform 120ms ease, box-shadow 120ms ease, background 120ms ease;
    }
    .edit-btn{ background:#f7f9fc; color:var(--text); }
    .delete-btn{ background:#fff6f6; color:#c0392b; }
    .edit-btn:hover,.delete-btn:hover{
      transform:translateY(-1px);
      box-shadow:0 10px 16px rgba(15,23,42,.08);
    }
    .delete-btn:hover{ background:#ffecec; }

    .empty-note{
      color:var(--muted);
      font-size:14px;
      text-align:center;
      border:1px dashed var(--grid);
      border-radius:10px;
      padding:12px;
    }
    .edit-form{
      margin-top:10px;
      display:grid;
      gap:8px;
    }
    .edit-grid{
      display:grid;
      grid-template-columns:1fr 130px 130px;
      gap:8px;
      align-items:center;
    }
    .modal-input,.modal-select{
      border:1px solid var(--grid);
      border-radius:8px;
      padding:9px 10px;
      font-size:14px;
      background:#fff;
    }
    .edit-actions{
      display:flex;
      gap:8px;
      justify-content:flex-end;
      flex-wrap:wrap;
    }
    .name-row.editing{ border-color:#d0dcf4; box-shadow:0 10px 16px rgba(15,23,42,.06); }

    /* Views */
    .view-switch{
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:center;
      flex-wrap:wrap;
      margin:14px 0 6px;
    }
    .view-switch button{
      min-width:110px;
    }
    .view-switch .print-btn{
      min-width:130px;
    }
    .view-switch .export-btn{
      min-width:150px;
    }
    .view-switch .reset-btn{
      min-width:auto;
    }
    .view-btn{
      border:1px solid var(--grid);
      border-radius:10px;
      padding:8px 12px;
      background:#fff;
      cursor:pointer;
      font-weight:700;
      color:var(--text);
      transition:background 120ms ease, box-shadow 120ms ease, transform 120ms ease;
    }
    .view-btn.active{
      background:#eef4ff;
      box-shadow:0 8px 16px rgba(15,23,42,.08);
      border-color:#d0dcf4;
    }
    .week-grid{ display:flex; flex-direction:column; gap:8px; padding:8px; }
    .week-row{ display:grid; grid-template-columns:repeat(7,1fr); gap:8px; }
    .week-nav{
      display:flex;
      justify-content:center;
      align-items:center;
      gap:10px;
      margin:6px 8px 0;
    }
    .nav-btn{
      border:1px solid var(--grid);
      border-radius:10px;
      padding:6px 10px;
      background:#fff;
      cursor:pointer;
      font-weight:700;
      color:var(--text);
      transition:background 120ms ease, box-shadow 120ms ease, transform 120ms ease;
    }
    .nav-btn:hover{
      background:#eef4ff;
      box-shadow:0 8px 16px rgba(15,23,42,.08);
      transform:translateY(-1px);
    }

    /* ---- ADD MODAL (new) ---- */
    .add-overlay{
      position:fixed;
      inset:0;
      background:rgba(15,23,42,.35);
      display:none;
      align-items:center;
      justify-content:center;
      padding:18px;
      z-index:2000;
    }
    .add-modal{
      width:min(520px, 94vw);
      background:#fff;
      border:1px solid var(--grid);
      border-radius:14px;
      box-shadow:0 16px 48px rgba(15,23,42,.18);
      padding:12px;
    }
    .add-head{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:6px 6px 10px;
    }
    .add-title{
      margin:0;
      font-size:16px;
      font-weight:700;
    }
    .add-body{
      display:flex;
      flex-direction:column;
      gap:12px;
      padding:6px;
    }
    .add-rows{ display:flex; flex-direction:column; gap:10px; }
    .add-person{
      border:1px solid var(--grid);
      border-radius:12px;
      padding:10px;
      display:grid;
      grid-template-columns: 1fr 220px;
      gap:10px;
      background:#fdfefe;
      box-shadow:0 8px 20px rgba(15,23,42,.06);
    }
    .add-left{ display:flex; flex-direction:column; gap:8px; }
    .add-right{ display:flex; flex-direction:column; gap:8px; align-items:stretch; justify-content:space-between; }
    .add-name{
      width:100%;
      border:1px solid var(--grid);
      border-radius:10px;
      padding:10px 12px;
      font-size:14px;
    }

    select option[disabled]{ display:none; }
    .shift-wrap{
      border:1px solid var(--grid);
      border-radius:10px;
      padding:8px 10px;
      background:#f8fbff;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      cursor:pointer;
      user-select:none;
    }
    .shift-wrap *{ cursor:pointer; }
    .shift-select{
      border:none;
      background:transparent;
      outline:none;
      font-weight:700;
      font-size:14px;
      appearance:none;
      width:100%;
    }
    .chev{
      width:11px;height:11px;
      border-right:2px solid var(--muted);
      border-bottom:2px solid var(--muted);
      transform:rotate(45deg);
      opacity:.85;
      flex:0 0 auto;
      margin-top:-2px;
    }

    .time-row{
      display:grid;
      grid-template-columns: 1fr 18px 1fr;
      gap:8px;
      align-items:center;
    }
    .time-input{
      border:1px solid var(--grid);
      border-radius:10px;
      padding:10px 12px;
      font-size:14px;
      font-weight:700;
      width:100%;
    }
    .dash{ text-align:center; color:var(--muted); font-weight:700; }

    .add-actions{
      display:flex;
      justify-content:space-between;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
    }
    .btn{
      border:1px solid var(--grid);
      border-radius:10px;
      padding:10px 12px;
      background:#fff;
      cursor:pointer;
      font-weight:700;
      color:var(--text);
      transition:background 120ms ease, transform 120ms ease, box-shadow 120ms ease;
    }
    .btn:hover{
      background:#eef4ff;
      transform:translateY(-1px);
      box-shadow:0 8px 16px rgba(15,23,42,.08);
    }
    .btn.primary{ background:#eef4ff; border-color:#d0dcf4; }
    .btn.danger{ background:#fff6f6; color:#c0392b; }

    .icon-btn{
      width:44px;height:44px;
      border:1px solid var(--grid);
      border-radius:10px;
      background:#f8fbff;
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:center;
      transition:background 120ms ease, transform 120ms ease, box-shadow 120ms ease;
    }
    .icon-btn:hover{
      background:#eef4ff;
      transform:translateY(-1px);
      box-shadow:0 8px 16px rgba(15,23,42,.08);
    }
    .cal-icon{
      width:22px;height:22px;
      fill:none;
      stroke:var(--accent);
      stroke-width:2.2;
      stroke-linecap:round;
      stroke-linejoin:round;
    }
    .chip{
      font-size:12px;
      font-weight:700;
      padding:6px 8px;
      border-radius:999px;
      background:#f1f5fb;
      border:1px solid var(--grid);
      color:var(--text);
    }
    .row-dates{
      display:flex;
      align-items:center;
      gap:8px;
      flex-wrap:wrap;
    }
    .row-chips{
      display:flex;
      flex-wrap:wrap;
      gap:6px;
    }
    .calendar-btn .cal-icon{
      width:20px;
      height:20px;
    }

    /* ---- Date picker ---- */
    .dp-overlay{
      position:fixed;
      inset:0;
      background:rgba(15,23,42,.35);
      display:none;
      align-items:center;
      justify-content:center;
      padding:18px;
      z-index:2500;
    }
    .dp{
      width:min(480px, 94vw);
      background:#fff;
      border:1px solid var(--grid);
      border-radius:14px;
      box-shadow:0 16px 48px rgba(15,23,42,.18);
      padding:12px;
    }
    .dp-head{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:6px 6px 10px;
    }
    .dp-title{ margin:0; font-size:16px; font-weight:700; }
    .dp-dow{
      display:grid;
      grid-template-columns:repeat(7,1fr);
      gap:6px;
      padding:0 6px 8px;
      color:var(--muted);
      font-size:12px;
      font-weight:700;
      text-transform:uppercase;
      letter-spacing:.6px;
    }
    .dp-grid{
      display:grid;
      grid-template-columns:repeat(7,1fr);
      gap:6px;
      padding:0 6px 10px;
    }
    .dp-day{
      height:42px;
      border:1px solid var(--grid);
      border-radius:10px;
      background:#fff;
      cursor:pointer;
      font-weight:700;
      display:flex;
      align-items:center;
      justify-content:center;
      user-select:none;
      transition:transform 120ms ease, background 120ms ease, box-shadow 120ms ease;
    }
    .dp-day:hover{
      transform:translateY(-1px);
      box-shadow:0 8px 14px rgba(15,23,42,.08);
      background:#f7f9fc;
    }
    .dp-day.blank{ opacity:.35; cursor:default; background:#fafbfe; }
    .dp-day.selected{
      background:rgba(47,128,237,.12);
      border-color:rgba(47,128,237,.55);
    }
    .dp-actions{
      display:flex;
      justify-content:flex-end;
      gap:8px;
      padding:6px;
    }
    .dp-shortcuts{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      padding:0 6px 8px;
    }

    /* ---- Print view ---- */
    .print-btn{
      border:1px solid var(--grid);
      border-radius:10px;
      padding:8px 12px;
      background:#0f172a;
      color:#fff;
      cursor:pointer;
      font-weight:700;
      transition:transform 120ms ease, box-shadow 120ms ease, background 120ms ease;
    }
    .print-btn:hover{
      transform:translateY(-1px);
      box-shadow:0 8px 18px rgba(15,23,42,.18);
      background:#162c4a;
    }
    .print-sheet{
      display:none;
      width:min(980px, 96vw);
      margin:0 auto;
      background:#fff;
      color:#0f172a;
      padding:18px;
      border-radius:12px;
      box-shadow:0 16px 40px rgba(15,23,42,.16);
      box-sizing:border-box;
    }
    body.printing .wrap,
    body.printing .modal-overlay,
    body.printing .add-overlay,
    body.printing .dp-overlay{
      display:none;
    }
    body.printing .print-sheet{
      display:block;
    }
    .print-head{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
      margin-bottom:12px;
    }
    .print-title{
      margin:0;
      font-size:20px;
      font-weight:700;
      letter-spacing:.2px;
    }
    .print-meta{
      margin:4px 0 0;
      color:var(--muted);
      font-size:13px;
    }
    .print-badge{
      background:#eef4ff;
      color:#1f2b3a;
      border:1px solid #d0dcf4;
      border-radius:999px;
      padding:8px 12px;
      font-weight:700;
      font-size:12px;
      flex:0 0 auto;
    }
    .print-table{
      width:100%;
      border-collapse:collapse;
      table-layout:fixed;
      font-size:13px;
    }
    .print-table th,
    .print-table td{
      border-bottom:1px solid #e5e7eb;
      padding:8px 10px;
      text-align:left;
      vertical-align:top;
    }
    .print-table th{
      background:#f8fafc;
      font-size:12px;
      text-transform:uppercase;
      letter-spacing:.4px;
      color:#4b5563;
    }
    .print-table tbody tr:nth-child(even){ background:#f9fafb; }
    .print-table th:nth-child(1),
    .print-table td:nth-child(1){ width:22%; white-space:nowrap; font-weight:700; }
    .print-table th:nth-child(2),
    .print-table td:nth-child(2){ width:33%; }
    .print-table th:nth-child(3),
    .print-table td:nth-child(3){ width:20%; white-space:nowrap; }
    .print-table th:nth-child(4),
    .print-table td:nth-child(4){ width:25%; white-space:nowrap; }
    .print-empty{
      text-align:center;
      color:var(--muted);
      font-style:italic;
      padding:14px 10px;
    }
    .summary-btn{
      border:1px solid var(--grid);
      border-radius:10px;
      padding:8px 12px;
      background:#f8fbff;
      cursor:pointer;
      font-weight:700;
      color:var(--text);
      transition:background 120ms ease, box-shadow 120ms ease, transform 120ms ease;
    }
    .summary-btn:hover{
      background:#eef4ff;
      box-shadow:0 8px 16px rgba(15,23,42,.08);
      transform:translateY(-1px);
    }
    .shift-modal{ width:min(620px, 94vw); }
    .shift-list{ display:grid; gap:10px; margin-top:8px; }
    .shift-row{
      border:1px solid var(--grid);
      border-radius:12px;
      padding:10px;
      background:#fff;
      display:grid;
      gap:8px;
    }
    .shift-grid{
      display:grid;
      grid-template-columns:1.4fr 1fr 1fr;
      gap:8px;
      align-items:center;
    }
    .shift-actions{
      display:flex;
      justify-content:flex-end;
      gap:8px;
    }
    .shift-add{
      margin-top:12px;
      border-top:1px dashed var(--grid);
      padding-top:10px;
      display:grid;
      gap:8px;
    }
    .shift-add-title{
      font-weight:700;
      color:var(--text);
      font-size:14px;
    }
    .shift-empty{
      text-align:center;
      color:var(--muted);
      font-style:italic;
      padding:10px;
      border:1px dashed var(--grid);
      border-radius:10px;
    }
    .export-btn{
      border:1px solid var(--grid);
      border-radius:10px;
      padding:8px 12px;
      background:#fff;
      cursor:pointer;
      font-weight:700;
      color:var(--text);
      transition:background 120ms ease, box-shadow 120ms ease, transform 120ms ease;
    }
    .export-btn:hover{
      background:#eef4ff;
      box-shadow:0 8px 16px rgba(15,23,42,.08);
      transform:translateY(-1px);
    }
    .reset-btn{
      border:1px solid #f1c0c0;
      border-radius:10px;
      padding:6px 10px;
      background:#fff6f6;
      cursor:pointer;
      font-weight:700;
      color:#c0392b;
      font-size:12px;
      transition:transform 120ms ease, box-shadow 120ms ease, background 120ms ease;
    }
    .reset-btn:hover{
      background:#ffecec;
      box-shadow:0 8px 16px rgba(192,57,43,.12);
      transform:translateY(-1px);
    }
    .summary-modal{ width:min(520px, 94vw); }
    .summary-table{
      width:100%;
      border-collapse:collapse;
      font-size:14px;
      margin-top:10px;
    }
    .summary-table th,
    .summary-table td{
      border-bottom:1px solid var(--grid);
      padding:8px 6px;
      text-align:left;
    }
    .summary-table th{
      color:var(--muted);
      font-size:12px;
      text-transform:uppercase;
      letter-spacing:.4px;
    }
    .summary-table th:nth-child(1),
    .summary-table td:nth-child(1){ width:50%; }
    .summary-table th:nth-child(2),
    .summary-table td:nth-child(2){ width:25%; white-space:nowrap; }
    .summary-table th:nth-child(3),
    .summary-table td:nth-child(3){ width:25%; white-space:nowrap; }
    .summary-empty{
      text-align:center;
      color:var(--muted);
      font-style:italic;
      padding:12px 8px;
    }
    .employee-btn{
      border:1px solid var(--grid);
      border-radius:10px;
      padding:8px 12px;
      background:#fff;
      cursor:pointer;
      font-weight:700;
      color:var(--text);
      transition:background 120ms ease, box-shadow 120ms ease, transform 120ms ease;
    }
    .employee-btn:hover{
      background:#eef4ff;
      box-shadow:0 8px 16px rgba(15,23,42,.08);
      transform:translateY(-1px);
    }
    .employee-modal{ width:min(640px, 94vw); }
    .employee-form{ display:grid; gap:10px; margin-top:6px; }
    .employee-grid{ display:grid; grid-template-columns:1fr 1fr; gap:8px; }
    .modal-textarea{
      border:1px solid var(--grid);
      border-radius:8px;
      padding:9px 10px;
      font-size:14px;
      background:#fff;
      font-family:inherit;
      min-height:64px;
      resize:vertical;
    }
    .employee-actions{ display:flex; justify-content:flex-end; }
    .employee-list{
      margin-top:12px;
      display:grid;
      gap:8px;
      max-height:260px;
      overflow-y:auto;
      padding-right:4px;
    }
    .employee-card{
      border:1px solid var(--grid);
      border-radius:10px;
      padding:10px;
      display:flex;
      flex-direction:column;
      gap:6px;
      background:#fdfefe;
    }
    .employee-title{
      font-weight:700;
      display:flex;
      justify-content:space-between;
      gap:10px;
      align-items:center;
    }
    .employee-meta{
      color:var(--muted);
      font-size:12px;
      line-height:1.4;
    }
    .employee-delete{
      border:1px solid var(--grid);
      background:#fff6f6;
      color:#c0392b;
      border-radius:8px;
      padding:6px 8px;
      font-weight:700;
      cursor:pointer;
    }
    .employee-empty{
      text-align:center;
      color:var(--muted);
      font-style:italic;
      padding:10px;
      border:1px dashed var(--grid);
      border-radius:10px;
    }
    @page{
      size:A4 landscape;
      margin:12mm;
    }
    @media print{
      body{
        background:#fff;
      }
      .wrap,
      .modal-overlay,
      .add-overlay,
      .dp-overlay{
        display:none !important;
      }
      .print-sheet{
        display:block !important;
        box-shadow:none;
        padding:0;
        width:100% !important;
        max-width:none;
      }
      .print-table{ font-size:12px; }
    }

    @media (max-width: 560px){
      .add-person{ grid-template-columns: 1fr; }
    .add-right{ flex-direction:row; align-items:center; justify-content:flex-start; gap:10px; }
    .icon-btn{ width:48px; height:48px; }
    .edit-grid{ grid-template-columns:1fr; }
    .row-dates{ flex-direction:column; align-items:flex-start; }
    .view-side{
      position:static;
      flex-direction:row;
      justify-content:center;
      flex-wrap:wrap;
      margin-bottom:8px;
    }
  }
  @media (max-width: 1200px){
    .view-side{
      position:static;
      flex-direction:row;
      justify-content:center;
      flex-wrap:wrap;
      margin-bottom:8px;
    }
  }
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <h1 id="heading-title">Calendrier</h1>
      <p class="subtitle">Calendrier généré côté client (lundi en première colonne).</p>
      <div class="month-controls">
        <button class="nav-btn" id="month-prev" type="button" aria-label="Mois précédent">‹</button>
        <select class="month-select" id="month-select" aria-label="Mois"></select>
        <select class="year-select" id="year-select" aria-label="Année"></select>
        <button class="nav-btn" id="month-next" type="button" aria-label="Mois suivant">›</button>
      </div>
    </header>

    <div class="view-switch">
      <button class="employee-btn" id="team-btn" type="button">Équipe</button>
      <button class="employee-btn" id="employee-btn" type="button">+ Employé</button>
      <button class="employee-btn" id="shift-btn" type="button">Shifts</button>
      <button class="summary-btn" id="summary-btn" type="button">Résumé heures</button>
      <button class="export-btn" id="export-btn" type="button">Exporter Excel</button>
      <button class="print-btn" id="print-btn" type="button">Imprimer</button>
      <button class="reset-btn" id="reset-btn" type="button">Réinitialiser</button>
    </div>

    <div class="calendar-shell">
      <div class="view-side">
        <button class="view-btn active" id="btn-month" type="button">Mois</button>
        <button class="view-btn" id="btn-week" type="button">Semaine</button>
        <button class="view-btn" id="btn-biweek" type="button">2 Semaines</button>
      </div>

      <section class="calendar" id="month-container">
        <div class="grid" id="calendar-grid"></div>
        <div class="legend">
          <span><span class="dot"></span> Jours spéciaux (Noël & Réveillon)</span>
        </div>
      </section>

      <section class="calendar" id="week-container" hidden>
        <div class="week-nav" id="week-nav">
          <button class="nav-btn" id="prev-week" type="button">‹</button>
          <div class="week-range" id="week-range"></div>
          <button class="nav-btn" id="next-week" type="button">›</button>
        </div>
        <div class="week-grid" id="week-grid"></div>
      </section>

      <section class="calendar" id="biweek-container" hidden>
        <div class="week-nav" id="biweek-nav">
          <button class="nav-btn" id="prev-biweek" type="button">‹</button>
          <div class="week-range" id="biweek-range"></div>
          <button class="nav-btn" id="next-biweek" type="button">›</button>
        </div>
        <div class="week-grid" id="biweek-grid"></div>
      </section>
    </div>
  </div>

  <!-- List modal -->
  <div class="modal-overlay" id="modal-overlay" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true">
      <div class="modal-header">
        <h2 class="modal-title" id="modal-title">Noms</h2>
        <button class="close-btn" id="close-modal" aria-label="Fermer">×</button>
      </div>
      <div class="name-list" id="name-list"></div>
    </div>
  </div>

  <!-- Add modal -->
  <div class="add-overlay" id="add-overlay" aria-hidden="true">
    <div class="add-modal" role="dialog" aria-modal="true">
      <div class="add-head">
        <h3 class="add-title" id="add-title">Ajouter</h3>
        <button class="close-btn" id="add-close" aria-label="Fermer">×</button>
      </div>

      <div class="add-body">
        <div class="add-rows" id="add-rows"></div>

        <div class="add-actions">
          <div style="display:flex; gap:8px; align-items:center;">
            <button class="btn" id="add-row-btn" type="button">+ Personne</button>
            <button class="btn primary" id="validate-add" type="button">Valider</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Date picker modal -->
  <div class="dp-overlay" id="dp-overlay" aria-hidden="true">
    <div class="dp" role="dialog" aria-modal="true">
      <div class="dp-head">
        <h3 class="dp-title" id="dp-title">Sélectionner des dates</h3>
        <button class="close-btn" id="dp-close" aria-label="Fermer">×</button>
      </div>

      <div class="dp-shortcuts">
        <button class="btn" id="dp-all-month" type="button">Tout le mois</button>
        <button class="btn" id="dp-week-range" type="button">Semaine affichée</button>
        <button class="btn" id="dp-biweek-range" type="button">2 semaines affichées</button>
      </div>

      <div class="dp-dow">
        <div>Lun</div><div>Mar</div><div>Mer</div><div>Jeu</div><div>Ven</div><div>Sam</div><div>Dim</div>
      </div>

      <div class="dp-grid" id="dp-grid"></div>

      <div class="dp-actions">
        <button class="btn" id="dp-clear" type="button">Effacer</button>
        <button class="btn primary" id="dp-ok" type="button">OK</button>
      </div>
    </div>
  </div>

  <!-- Printable sheet -->
  <section class="print-sheet" id="print-sheet" hidden>
    <div class="print-head">
      <div>
        <h2 class="print-title" id="print-title">Planning</h2>
        <p class="print-meta" id="print-meta"></p>
      </div>
      <div class="print-badge">Vue imprimable</div>
    </div>
    <table class="print-table" aria-label="Planning imprimable">
      <thead>
        <tr>
          <th>Date</th>
          <th>Nom</th>
          <th>Shift</th>
          <th>Horaires</th>
        </tr>
      </thead>
      <tbody id="print-body"></tbody>
    </table>
  </section>

  <!-- Summary modal -->
  <div class="modal-overlay" id="summary-overlay" aria-hidden="true">
    <div class="modal summary-modal" role="dialog" aria-modal="true">
      <div class="modal-header">
        <h2 class="modal-title">Résumé des heures</h2>
        <button class="close-btn" id="summary-close" aria-label="Fermer">×</button>
      </div>
      <table class="summary-table" aria-label="Résumé des heures">
        <thead>
          <tr>
            <th>Nom</th>
            <th>Heures</th>
            <th>Total</th>
          </tr>
        </thead>
        <tbody id="summary-body"></tbody>
      </table>
    </div>
  </div>

  <!-- Shift modal -->
  <div class="modal-overlay" id="shift-overlay" aria-hidden="true">
    <div class="modal shift-modal" role="dialog" aria-modal="true">
      <div class="modal-header">
        <h2 class="modal-title">Shifts</h2>
        <button class="close-btn" id="shift-close" aria-label="Fermer">×</button>
      </div>
      <div class="shift-list" id="shift-list"></div>
      <div class="shift-add">
        <div class="shift-add-title">Ajouter un shift</div>
        <div class="shift-grid">
          <input class="modal-input" id="shift-new-name" type="text" placeholder="Nom du shift" aria-label="Nom du shift">
          <input class="modal-input" id="shift-new-start" type="time" aria-label="Début">
          <input class="modal-input" id="shift-new-end" type="time" aria-label="Fin">
        </div>
        <div class="shift-actions">
          <button class="btn primary" id="shift-add-btn" type="button">Ajouter</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Employee modal -->
  <div class="modal-overlay" id="employee-overlay" aria-hidden="true">
    <div class="modal employee-modal" role="dialog" aria-modal="true">
      <div class="modal-header">
        <h2 class="modal-title" id="employee-title">Employés</h2>
        <button class="close-btn" id="employee-close" aria-label="Fermer">×</button>
      </div>
      <form class="employee-form" id="employee-form">
        <div class="employee-grid">
          <input class="modal-input" id="emp-lastname" type="text" placeholder="Nom">
          <input class="modal-input" id="emp-firstname" type="text" placeholder="Prénom">
        </div>
        <div class="employee-grid">
          <input class="modal-input" id="emp-birth" type="date">
          <input class="modal-input" id="emp-phone" type="tel" placeholder="Tel">
        </div>
        <input class="modal-input" id="emp-address" type="text" placeholder="Adresse">
        <div class="employee-grid">
          <input class="modal-input" id="emp-th" type="text" placeholder="T H">
          <input class="modal-input" id="emp-pro" type="text" placeholder="Situation Pro">
        </div>
        <textarea class="modal-textarea" id="emp-perso" placeholder="Situation Perso"></textarea>
        <div class="employee-actions">
          <button class="btn primary" type="submit">Ajouter</button>
        </div>
      </form>
      <div class="employee-list" id="employee-list"></div>
    </div>
  </div>

<script>
  // ===== Gate: require entry from the home page =====
  (function(){
    const search = window.location.search || "";
    if (search.indexOf("from=login") === -1) {
      window.location.href = "index.html";
    }
  })();

  // ===== Calendar constants =====
  const monthNames = ["Janvier","Février","Mars","Avril","Mai","Juin","Juillet","Août","Septembre","Octobre","Novembre","Décembre"];
  const monthNamesShort = ["janv.","févr.","mars","avr.","mai","juin","juil.","août","sept.","oct.","nov.","déc."];
  const START_YEAR = 2025;
  const YEAR_SPAN = 20;
  const START_MONTH = 11; // décembre
  const MAX_MONTH_INDEX = YEAR_SPAN * 12 - 1;
  let currentYear = START_YEAR;
  let currentMonth = START_MONTH;
  let daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
  let startOffset = new Date(currentYear, currentMonth, 1).getDay();
  const specialsMD = new Set(["12-24", "12-25", "12-31"]); // Noël / réveillon pour tous les ans
  const names = ["Lun","Mar","Mer","Jeu","Ven","Sam","Dim"];
  const pad = (n) => String(n).padStart(2,"0");
  const isoForDay = (day, y = currentYear, m = currentMonth) => `${y}-${pad(m+1)}-${pad(day)}`;
  const fmtFR = (iso) => {
    const [y,m,d] = iso.split("-");
    return `${d}/${m}`;
  };
  const fmtLongFR = (iso) => {
    const [y,m,d] = iso.split("-").map(Number);
    const dt = new Date(y || currentYear, (m || 1) - 1, d || 1);
    return dt.toLocaleDateString("fr-FR", { weekday:"short", day:"2-digit", month:"2-digit", year:"numeric" });
  };
  const fmtExportDate = (iso) => {
    const [y,m,d] = iso.split("-").map(Number);
    if (!y || !m || !d) return "";
    const dt = new Date(y, m - 1, d);
    return dt.toLocaleDateString("fr-FR", { day:"2-digit", month:"2-digit", year:"numeric" });
  };
  const fmtExportWeekday = (iso) => {
    const [y,m,d] = iso.split("-").map(Number);
    if (!y || !m || !d) return "";
    const dt = new Date(y, m - 1, d);
    return dt.toLocaleDateString("fr-FR", { weekday:"short" });
  };
  const isSpecial = (iso) => {
    const [,m,d] = iso.split("-");
    if (!m || !d) return false;
    return specialsMD.has(`${m}-${d}`);
  };
  const monthLabel = (y, m) => `${monthNames[m]} ${y}`;
  const monthLabelShort = (m) => monthNamesShort[m] || monthNames[m] || "";

  // Employee key (fallback when ids differ)
  const normKey = (s) => (s || "").trim().toLowerCase().replace(/\s+/g, " ");
  const entryKey = (entry) => normKey(entry?.name || "");

  // ===== DOM refs =====
  const grid = document.getElementById("calendar-grid");
  const weekGrid = document.getElementById("week-grid");
  const biweekGrid = document.getElementById("biweek-grid");

  const monthContainer = document.getElementById("month-container");
  const weekContainer = document.getElementById("week-container");
  const biweekContainer = document.getElementById("biweek-container");
  const weekNav = document.getElementById("week-nav");
  const biweekNav = document.getElementById("biweek-nav");
  const monthSelect = document.getElementById("month-select");
  const yearSelect = document.getElementById("year-select");
  const monthPrev = document.getElementById("month-prev");
  const monthNext = document.getElementById("month-next");
  const headingTitle = document.getElementById("heading-title");

  const btnMonth = document.getElementById("btn-month");
  const btnWeek = document.getElementById("btn-week");
  const btnBiweek = document.getElementById("btn-biweek");

  const prevWeekBtn = document.getElementById("prev-week");
  const nextWeekBtn = document.getElementById("next-week");
  const weekRange = document.getElementById("week-range");

  const prevBiweekBtn = document.getElementById("prev-biweek");
  const nextBiweekBtn = document.getElementById("next-biweek");
  const biweekRange = document.getElementById("biweek-range");

  const grids = [grid, weekGrid, biweekGrid];
  const printBtn = document.getElementById("print-btn");
  const printSheet = document.getElementById("print-sheet");
  const printBody = document.getElementById("print-body");
  const printMeta = document.getElementById("print-meta");
  const printTitle = document.getElementById("print-title");
  const summaryBtn = document.getElementById("summary-btn");
  const exportBtn = document.getElementById("export-btn");
  const resetBtn = document.getElementById("reset-btn");
  const shiftBtn = document.getElementById("shift-btn");
  const summaryOverlay = document.getElementById("summary-overlay");
  const summaryClose = document.getElementById("summary-close");
  const summaryBody = document.getElementById("summary-body");
  const teamBtn = document.getElementById("team-btn");
  const employeeBtn = document.getElementById("employee-btn");
  const shiftOverlay = document.getElementById("shift-overlay");
  const shiftClose = document.getElementById("shift-close");
  const shiftList = document.getElementById("shift-list");
  const shiftNewName = document.getElementById("shift-new-name");
  const shiftNewStart = document.getElementById("shift-new-start");
  const shiftNewEnd = document.getElementById("shift-new-end");
  const shiftAddBtn = document.getElementById("shift-add-btn");
  const employeeOverlay = document.getElementById("employee-overlay");
  const employeeClose = document.getElementById("employee-close");
  const employeeTitle = document.getElementById("employee-title");
  const employeeForm = document.getElementById("employee-form");
  const employeeList = document.getElementById("employee-list");
  const empLastname = document.getElementById("emp-lastname");
  const empFirstname = document.getElementById("emp-firstname");
  const empBirth = document.getElementById("emp-birth");
  const empAddress = document.getElementById("emp-address");
  const empPhone = document.getElementById("emp-phone");
  const empTh = document.getElementById("emp-th");
  const empPro = document.getElementById("emp-pro");
  const empPerso = document.getElementById("emp-perso");

  const CAL_SVG = `
    <svg class="cal-icon" viewBox="0 0 24 24" aria-hidden="true">
      <rect x="3" y="5" width="18" height="16" rx="2"></rect>
      <path d="M16 3v4M8 3v4M3 9h18"></path>
      <path d="M8 13h2M12 13h2M16 13h2M8 17h2M12 17h2"></path>
    </svg>`;

  // ===== Data store =====
  const namesByDate = new Map(); // iso -> array of entries
  const initialsByDate = new Map(); // iso -> array of wrappers
  let entrySeq = 1;
  const genEntryId = () => `entry-${Date.now()}-${entrySeq++}`;
  const resetInitials = () => { initialsByDate.clear(); };

  const normalizeEntry = (val) => {
    if (!val && val !== 0) return { name:"", start:"", end:"", shift:"" };
    if (typeof val === "string") return { id: genEntryId(), name: val, start:"", end:"", shift:"" };
    const id = val.id || genEntryId();
    if (!val.id) val.id = id;
    return {
      id,
      name: val.name || "",
      start: val.start || "",
      end: val.end || "",
      shift: val.shift || ""
    };
  };

  function getNormalizedList(iso){
    const raw = namesByDate.get(iso) || [];
    let changed = false;
    const list = raw.map((v) => {
      const n = normalizeEntry(v);
      if (v !== n) changed = true;
      return n;
    });
    if (changed) namesByDate.set(iso, list);
    return list;
  }

  // Dates for an employee (id OR same name)
  const datesForEntry = (entry) => {
    const res = [];
    const id = entry?.id || "";
    const key = entryKey(entry);
    namesByDate.forEach((list, iso) => {
      const normalized = getNormalizedList(iso);
      const hit = normalized.some((e) => (id && e.id === id) || (key && entryKey(e) === key));
      if (hit) res.push(iso);
    });
    return res;
  };

  function removeEntryEverywhere(entry){
    const id = entry?.id || "";
    const key = entryKey(entry);
    namesByDate.forEach((list, iso) => {
      const normalized = getNormalizedList(iso);
      const next = normalized.filter((e) => !((id && e.id === id) || (key && entryKey(e) === key)));
      if (next.length !== normalized.length){
        namesByDate.set(iso, next);
        renderInitials(iso);
      }
    });
  }

  function applyEntryChanges(entry, selectedDates){
    const target = new Set(selectedDates);
    const id = entry?.id || "";
    const key = entryKey(entry);

    namesByDate.forEach((list, iso) => {
      const normalized = getNormalizedList(iso);

      const matchIdxs = [];
      normalized.forEach((e, i) => {
        if ((id && e.id === id) || (key && entryKey(e) === key)) matchIdxs.push(i);
      });

      const keep = target.has(iso);

      if (matchIdxs.length && !keep){
        for (let k = matchIdxs.length - 1; k >= 0; k--) normalized.splice(matchIdxs[k], 1);
        namesByDate.set(iso, normalized);
        renderInitials(iso);
      } else if (matchIdxs.length && keep){
        const firstIdx = matchIdxs[0];
        normalized[firstIdx] = { ...entry };
        for (let k = matchIdxs.length - 1; k >= 1; k--) normalized.splice(matchIdxs[k], 1);
        namesByDate.set(iso, normalized);
        renderInitials(iso);
        target.delete(iso);
      }
    });

    target.forEach((iso) => {
      const list = getNormalizedList(iso);
      list.push({ ...entry });
      namesByDate.set(iso, list);
      renderInitials(iso);
    });
  }

  function attachTimeAutoAdvance(input){
    input.addEventListener("focus", () => {
      const colon = input.value.indexOf(":");
      const endPos = colon > -1 ? colon : input.value.length;
      setTimeout(() => input.setSelectionRange(0, endPos), 0);
    });
    input.addEventListener("input", () => {
      const colon = input.value.indexOf(":");
      if (colon === -1) return;
      const digits = input.value.replace(/\D/g, "");
      if (digits.length >= 2 && (input.selectionStart || 0) <= colon + 1){
        const minuteStart = colon + 1;
        input.setSelectionRange(minuteStart, minuteStart + 2);
      }
    });
  }

  // ===== Density =====
  const updateDensityColor = (iso) => {
    const cells = document.querySelectorAll(`.date[data-iso="${iso}"]`);
    if (!cells.length) return;
    const count = (namesByDate.get(iso) || []).length;
    cells.forEach((cell) => {
      cell.classList.remove("density-med","density-high");
      if (count >= 5) cell.classList.add("density-high");
      else if (count >= 2) cell.classList.add("density-med");
    });
  };

  // ===== Initials rendering =====
  const registerInitialsWrap = (iso, el) => {
    const arr = initialsByDate.get(iso) || [];
    arr.push(el);
    initialsByDate.set(iso, arr);
  };

  function renderInitials(iso){
    const wraps = initialsByDate.get(iso) || [];
    wraps.forEach(w => w.innerHTML = "");
    const list = getNormalizedList(iso);

    const counts = new Map();
    const seen = new Map();
    list.forEach((n) => {
      const first = n.name.trim()[0]?.toUpperCase() || "";
      counts.set(first, (counts.get(first) || 0) + 1);
    });

    const count = list.length || 1;
    const baseFont = 12;
    const minFont = 6;
    const fontSize = Math.max(minFont, baseFont - (count - 1));
    const secondFont = Math.max(5, fontSize - 2);
    const padX = Math.max(1, 6 - (count - 1));

    list.forEach((n) => {
      const trimmed = n.name.trim();
      const first = trimmed[0]?.toUpperCase() || "";
      const second = trimmed[1]?.toLowerCase() || "";
      const occur = (seen.get(first) || 0) + 1;
      seen.set(first, occur);

      const badge = document.createElement("span");
      badge.className = "initial";
      badge.style.fontSize = `${fontSize}px`;
      badge.style.padding = `0 ${padX}px`;

      const spanFirst = document.createElement("span");
      spanFirst.textContent = first;
      badge.appendChild(spanFirst);

      if ((counts.get(first) || 0) > 1 && occur > 1 && second) {
        const spanSecond = document.createElement("span");
        spanSecond.className = "initial-second";
        spanSecond.textContent = second;
        spanSecond.style.fontSize = `${secondFont}px`;
        badge.appendChild(spanSecond);
      }

      wraps.forEach(w => w.appendChild(badge.cloneNode(true)));
    });

    wraps.forEach((wrap) => {
      let hiddenCount = 0;
      while ((wrap.scrollHeight > wrap.clientHeight || wrap.scrollWidth > wrap.clientWidth) && wrap.lastChild) {
        wrap.removeChild(wrap.lastChild);
        hiddenCount++;
      }
      if (hiddenCount > 0) {
        const ellipsis = document.createElement("span");
        ellipsis.className = "initial";
        ellipsis.style.fontSize = `${Math.max(5, fontSize - 1)}px`;
        ellipsis.style.padding = "0 4px";
        ellipsis.textContent = "...";
        wrap.appendChild(ellipsis);
      }
    });

    updateDensityColor(iso);
  }

  const parseTimeMinutes = (val) => {
    if (!val || typeof val !== "string" || val.indexOf(":") === -1) return null;
    const parts = val.split(":");
    if (parts.length < 2) return null;
    const h = parseInt(parts[0], 10);
    const m = parseInt(parts[1], 10);
    if (Number.isNaN(h) || Number.isNaN(m)) return null;
    return h * 60 + m;
  };
  const entryMinutes = (entry) => {
    const shift = entry.shift || "";
    const defaults = getShiftDefaults();
    const startVal = entry.start || defaults[shift]?.start || "";
    const endVal = entry.end || defaults[shift]?.end || "";
    const startMin = parseTimeMinutes(startVal);
    const endMin = parseTimeMinutes(endVal);
    if (startMin === null || endMin === null) return 0;
    let diff = endMin - startMin;
    if (diff < 0) diff += 24 * 60;
    return diff;
  };
  const formatMinutes = (mins) => {
    const total = Math.max(0, Math.round(mins));
    const h = Math.floor(total / 60);
    const m = total % 60;
    return m ? `${h}h${String(m).padStart(2,"0")}` : `${h}h`;
  };
  const formatNumber = (val) => {
    if (val === null || val === undefined || Number.isNaN(val)) return "—";
    return Number(val).toLocaleString("fr-FR", { minimumFractionDigits: 0, maximumFractionDigits: 2 });
  };

  // ===== Cells creation =====
  const createDateCell = (iso, day) => {
    const cell = document.createElement("div");
    cell.className = "date" + (isSpecial(iso) ? " special" : "");
    cell.dataset.iso = iso;
    if (!namesByDate.has(iso)) namesByDate.set(iso, []);

    const addBtn = document.createElement("button");
    addBtn.className = "add-btn";
    addBtn.type = "button";
    const [yStr, mStr] = iso.split("-");
    const monthIdx = Number(mStr) - 1;
    const shortLabel = monthLabelShort(monthIdx);
    addBtn.setAttribute("aria-label", `Ajouter pour le ${day} ${shortLabel} ${yStr}`);
    addBtn.textContent = "+";

    const number = document.createElement("div");
    number.className = "day-number";
    number.textContent = day;

    const initials = document.createElement("div");
    initials.className = "initials";
    registerInitialsWrap(iso, initials);

    cell.append(addBtn, number, initials);
    return cell;
  };

  const computeMonthMeta = () => {
    daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
    startOffset = (new Date(currentYear, currentMonth, 1).getDay() + 6) % 7;
  };
  const setDpTitle = () => {
    if (dpTitle) dpTitle.textContent = `${monthLabel(currentYear, currentMonth)} — sélectionner des dates`;
  };
  const monthIndexFromState = () => (currentYear - START_YEAR) * 12 + currentMonth;
  const syncSelectors = () => {
    if (monthSelect) monthSelect.value = String(currentMonth);
    if (yearSelect) yearSelect.value = String(currentYear);
  };
  const updateHeading = () => {
    const label = monthLabel(currentYear, currentMonth);
    if (headingTitle) headingTitle.textContent = label;
    document.title = `Calendrier ${label}`;
  };
  const setMonthIndex = (idx) => {
    const clamped = Math.max(0, Math.min(MAX_MONTH_INDEX, idx));
    currentYear = START_YEAR + Math.floor(clamped / 12);
    currentMonth = clamped % 12;
    computeMonthMeta();
    weekStartDay = 1;
    biweekStartDay = 1;
    syncSelectors();
    updateHeading();
    setDpTitle();
    setView(currentView);
  };
  const shiftMonth = (delta) => setMonthIndex(monthIndexFromState() + delta);
  const populateSelectors = () => {
    if (monthSelect && !monthSelect.children.length){
      monthNames.forEach((n, i) => {
        const opt = document.createElement("option");
        opt.value = i;
        opt.textContent = n;
        monthSelect.appendChild(opt);
      });
    }
    if (yearSelect && !yearSelect.children.length){
      for (let y = START_YEAR; y < START_YEAR + YEAR_SPAN; y++){
        const opt = document.createElement("option");
        opt.value = y;
        opt.textContent = y;
        yearSelect.appendChild(opt);
      }
    }
    syncSelectors();
  };

  const buildMonthGrid = () => {
    computeMonthMeta();
    if (!grid) return;
    grid.innerHTML = "";

    names.forEach((n) => {
      const cell = document.createElement("div");
      cell.className = "day-name";
      cell.textContent = n;
      grid.appendChild(cell);
    });

    for (let i = 0; i < startOffset; i++) {
      const empty = document.createElement("div");
      empty.className = "date empty";
      grid.appendChild(empty);
    }
    for (let day = 1; day <= daysInMonth; day++) {
      const iso = isoForDay(day);
      const cell = createDateCell(iso, day);
      grid.appendChild(cell);
      renderInitials(iso);
      updateDensityColor(iso);
    }
  };

  // ===== Week / Bi-week views =====
  let weekStartDay = 1;
  let biweekStartDay = 1;
  let currentView = "month";

  const buildWeekView = () => {
    computeMonthMeta();
    if (!weekGrid) return;
    weekGrid.innerHTML = "";
    const maxStart = Math.max(1, daysInMonth - 6);
    weekStartDay = Math.min(Math.max(1, weekStartDay), maxStart);
    const weekStart = weekStartDay;
    const weekEnd = Math.min(daysInMonth, weekStart + 6);
    const rangeLabel = `Semaine du ${pad(weekStart)} au ${pad(weekEnd)} ${monthLabelShort(currentMonth)} ${currentYear}`;
    if (weekRange) weekRange.textContent = rangeLabel;

    const row = document.createElement("div");
    row.className = "week-row";
    for (let i = 0; i < 7; i++) {
      const day = weekStart + i;
      if (day < 1 || day > daysInMonth) {
        const ph = document.createElement("div");
        ph.className = "date empty";
        row.appendChild(ph);
      } else {
        const iso = isoForDay(day);
        const cell = createDateCell(iso, day);
        row.appendChild(cell);
        updateDensityColor(iso);
        renderInitials(iso);
      }
    }
    weekGrid.appendChild(row);
  };

  const buildBiWeekView = () => {
    computeMonthMeta();
    if (!biweekGrid) return;
    biweekGrid.innerHTML = "";
    const maxStart = Math.max(1, daysInMonth - 13);
    biweekStartDay = Math.min(Math.max(1, biweekStartDay), maxStart);
    const start = biweekStartDay;
    const end = Math.min(daysInMonth, start + 13);
    const rangeLabel = `Semaine du ${pad(start)} au ${pad(end)} ${monthLabelShort(currentMonth)} ${currentYear}`;
    if (biweekRange) biweekRange.textContent = rangeLabel;

    let day = start;
    for (let r = 0; r < 2; r++) {
      const row = document.createElement("div");
      row.className = "week-row";
      for (let c = 0; c < 7; c++) {
        if (day > daysInMonth) {
          const ph = document.createElement("div");
          ph.className = "date empty";
          row.appendChild(ph);
        } else {
          const iso = isoForDay(day);
          const cell = createDateCell(iso, day);
          row.appendChild(cell);
          updateDensityColor(iso);
          renderInitials(iso);
          day++;
        }
      }
      biweekGrid.appendChild(row);
    }
  };

  const setView = (mode) => {
    const nextView = mode === "week" ? "week" : (mode === "biweek" ? "biweek" : "month");
    currentView = nextView;
    resetInitials();
    if (currentView === "week") buildWeekView();
    else if (currentView === "biweek") buildBiWeekView();
    else buildMonthGrid();

    monthContainer.hidden = currentView !== "month";
    weekContainer.hidden = currentView !== "week";
    weekNav.hidden = currentView !== "week";
    biweekContainer.hidden = currentView !== "biweek";
    biweekNav.hidden = currentView !== "biweek";

    btnMonth.classList.toggle("active", currentView === "month");
    btnWeek.classList.toggle("active", currentView === "week");
    btnBiweek.classList.toggle("active", currentView === "biweek");
    setDpTitle();
  };

  const initCalendar = () => {
    populateSelectors();
    updateHeading();
    setDpTitle();
    try {
      setView(currentView);
    } catch(err){
      console.error("Init setView failed:", err);
      buildMonthGrid();
    }
    if (grid && !grid.childElementCount) buildMonthGrid();
  };

  monthSelect?.addEventListener("change", (e) => {
    const newMonth = Number(e.target.value || 0);
    setMonthIndex((Number(yearSelect?.value || currentYear) - START_YEAR) * 12 + newMonth);
  });
  yearSelect?.addEventListener("change", (e) => {
    const newYear = Number(e.target.value || currentYear);
    setMonthIndex((newYear - START_YEAR) * 12 + currentMonth);
  });
  monthPrev?.addEventListener("click", () => shiftMonth(-1));
  monthNext?.addEventListener("click", () => shiftMonth(1));

  btnMonth.addEventListener("click", () => setView("month"));
  btnWeek.addEventListener("click", () => setView("week"));
  btnBiweek.addEventListener("click", () => setView("biweek"));

  prevWeekBtn.addEventListener("click", () => { weekStartDay = Math.max(1, weekStartDay - 7); buildWeekView(); });
  nextWeekBtn.addEventListener("click", () => { weekStartDay += 7; buildWeekView(); });

  prevBiweekBtn.addEventListener("click", () => { biweekStartDay -= 14; buildBiWeekView(); });
  nextBiweekBtn.addEventListener("click", () => { biweekStartDay += 14; buildBiWeekView(); });

  if (document.readyState === "loading") document.addEventListener("DOMContentLoaded", initCalendar);
  else initCalendar();

  // ===== Modal list behavior =====
  const overlay = document.getElementById("modal-overlay");
  const closeModalBtn = document.getElementById("close-modal");
  const modalTitle = document.getElementById("modal-title");
  const nameList = document.getElementById("name-list");

  function openModal(iso, day){
    overlay.dataset.iso = iso;
    const [yStr, mStr] = iso.split("-");
    const monthIdx = Number(mStr) - 1;
    modalTitle.textContent = `Noms pour le ${day} ${monthLabelShort(monthIdx)} ${yStr}`;
    renderModalList(iso);
    overlay.style.display = "flex";
    overlay.setAttribute("aria-hidden","false");
  }
  function closeModal(){
    overlay.style.display = "none";
    overlay.setAttribute("aria-hidden","true");
    overlay.dataset.iso = "";
  }
  closeModalBtn.addEventListener("click", closeModal);
  overlay.addEventListener("click", (e) => { if (e.target === overlay) closeModal(); });
  document.addEventListener("keydown", (e) => { if (e.key === "Escape") closeModal(); });

  // ===== Add flow refs =====
  const addOverlay = document.getElementById("add-overlay");
  const addClose = document.getElementById("add-close");
  const addRows = document.getElementById("add-rows");
  const addRowBtn = document.getElementById("add-row-btn");
  const validateAdd = document.getElementById("validate-add");
  const addTitle = document.getElementById("add-title");

  const dpOverlay = document.getElementById("dp-overlay");
  const dpGrid = document.getElementById("dp-grid");
  const dpClose = document.getElementById("dp-close");
  const dpClear = document.getElementById("dp-clear");
  const dpOk = document.getElementById("dp-ok");
  const dpTitle = document.getElementById("dp-title");
  const dpAllMonth = document.getElementById("dp-all-month");
  const dpWeekRange = document.getElementById("dp-week-range");
  const dpBiweekRange = document.getElementById("dp-biweek-range");

  const SHIFT_KEY = "shift-options";
  const DEFAULT_SHIFTS = [
    { id: "shift-matin", name: "Matin", start: "09:00", end: "13:00" },
    { id: "shift-midi", name: "Midi", start: "14:00", end: "17:00" },
    { id: "shift-soir", name: "Soir", start: "18:00", end: "00:00" }
  ];
  let shiftCache = null;
  const shiftId = () => `shift-${Date.now()}-${Math.random().toString(16).slice(2,8)}`;
  const normalizeShift = (shift) => {
    if (!shift || typeof shift !== "object") return null;
    const name = (shift.name || "").trim();
    if (!name) return null;
    return {
      id: shift.id || shiftId(),
      name,
      start: (shift.start || "").trim(),
      end: (shift.end || "").trim()
    };
  };
  const loadShifts = () => {
    if (shiftCache) return shiftCache;
    let list = [];
    try {
      const raw = localStorage.getItem(SHIFT_KEY);
      if (raw) {
        const parsed = JSON.parse(raw);
        if (Array.isArray(parsed)) {
          list = parsed.map(normalizeShift).filter(Boolean);
        }
      }
    } catch(err){
      console.error("Erreur chargement shifts:", err);
    }
    if (!list.length) list = DEFAULT_SHIFTS.map((s) => ({ ...s }));
    shiftCache = list;
    try { localStorage.setItem(SHIFT_KEY, JSON.stringify(list)); }
    catch(err){ console.error("Erreur sauvegarde shifts:", err); }
    return list;
  };
  const saveShifts = (list) => {
    shiftCache = list;
    try { localStorage.setItem(SHIFT_KEY, JSON.stringify(list || [])); }
    catch(err){ console.error("Erreur sauvegarde shifts:", err); }
  };
  const getShiftDefaults = () => {
    const map = {};
    loadShifts().forEach((s) => {
      map[s.name] = { start: s.start || "", end: s.end || "" };
    });
    return map;
  };
  const isShiftNameTaken = (name, ignoreId = null) => {
    const key = normKey(name);
    return loadShifts().some((s) => s.id !== ignoreId && normKey(s.name) === key);
  };

  const makeEntry = (data) => ({
    id: genEntryId(),
    name: data.name || "",
    shift: data.shift || "",
    start: data.start || "",
    end: data.end || ""
  });

  let addBaseIso = "";
  let activeDateSet = null;
  let activeDateChips = null;
  let dpOnOk = null;

  function renderDateChipsFor(set, container){
    container.innerHTML = "";
    const arr = Array.from(set).sort();
    if (!arr.length){
      const c = document.createElement("span");
      c.className = "chip";
      c.textContent = "Date (calendrier)";
      container.appendChild(c);
      return;
    }
    arr.slice(0, 8).forEach((d) => {
      const chip = document.createElement("span");
      chip.className = "chip";
      chip.textContent = fmtFR(d);
      container.appendChild(chip);
    });
    if (arr.length > 8){
      const more = document.createElement("span");
      more.className = "chip";
      more.textContent = `+${arr.length - 8}`;
      container.appendChild(more);
    }
  }

  const closeNameDropdowns = () => {
    const open = document.querySelectorAll(".name-dropdown:not([hidden])");
    open.forEach((el) => {
      el.hidden = true;
      const btn = el.parentElement?.querySelector(".name-plus-btn");
      if (btn) btn.setAttribute("aria-expanded","false");
    });
  };

  function openAddModal(baseIso){
    closeEmployees();
    closeSummary();
    addBaseIso = baseIso;
    addRows.innerHTML = "";
    addRows.appendChild(createPersonRow());
    addTitle.textContent = `Ajouter (base: ${fmtFR(baseIso)})`;
    addOverlay.style.display = "flex";
    addOverlay.setAttribute("aria-hidden","false");
  }

  function closeAddModal(){
    addOverlay.style.display = "none";
    addOverlay.setAttribute("aria-hidden","true");
    addBaseIso = "";
    closeNameDropdowns();
  }

  addClose.addEventListener("click", closeAddModal);
  addOverlay.addEventListener("click", (e) => { if (e.target === addOverlay) closeAddModal(); });

  // ===== Date picker =====
  function renderDp(){
    computeMonthMeta();
    dpGrid.innerHTML = "";
    const offset = startOffset;
    const dim = daysInMonth;
    const selected = activeDateSet || new Set();

    for (let i=0;i<offset;i++){
      const b = document.createElement("div");
      b.className = "dp-day blank";
      b.textContent = "";
      dpGrid.appendChild(b);
    }
    for (let d=1; d<=dim; d++){
      const iso = isoForDay(d);
      const cell = document.createElement("div");
      cell.className = "dp-day" + (selected.has(iso) ? " selected" : "");
      cell.textContent = String(d);

      cell.addEventListener("click", () => {
        if (!activeDateSet) return;
        if (activeDateSet.has(iso)) activeDateSet.delete(iso);
        else activeDateSet.add(iso);
        renderDp();
        if (activeDateChips) renderDateChipsFor(activeDateSet, activeDateChips);
      });

      dpGrid.appendChild(cell);
    }
  }

  function openDpFor(set, chips, onOk){
    activeDateSet = set;
    activeDateChips = chips;
    dpOnOk = onOk || null;
    setDpTitle();
    dpOverlay.style.display = "flex";
    dpOverlay.setAttribute("aria-hidden","false");
    renderDp();
  }
  function closeDp(){
    dpOverlay.style.display = "none";
    dpOverlay.setAttribute("aria-hidden","true");
    activeDateSet = null;
    activeDateChips = null;
    dpOnOk = null;
  }

  dpClose.addEventListener("click", closeDp);
  dpOverlay.addEventListener("click", (e) => { if (e.target === dpOverlay) closeDp(); });
  dpClear.addEventListener("click", () => {
    if (activeDateSet) activeDateSet.clear();
    renderDp();
    if (activeDateChips && activeDateSet) renderDateChipsFor(activeDateSet, activeDateChips);
  });
  dpOk.addEventListener("click", () => {
    if (dpOnOk) dpOnOk();
    closeDp();
  });
  const addRangeToActive = (isos) => {
    if (!activeDateSet) return;
    isos.forEach((iso) => activeDateSet.add(iso));
    renderDp();
    if (activeDateChips) renderDateChipsFor(activeDateSet, activeDateChips);
  };
  const monthIsos = () => {
    computeMonthMeta();
    const res = [];
    for (let d=1; d<=daysInMonth; d++) res.push(isoForDay(d));
    return res;
  };
  const weekIsos = () => {
    computeMonthMeta();
    const res = [];
    const end = Math.min(daysInMonth, weekStartDay + 6);
    for (let d = weekStartDay; d <= end; d++) res.push(isoForDay(d));
    return res;
  };
  const biweekIsos = () => {
    computeMonthMeta();
    const res = [];
    const end = Math.min(daysInMonth, biweekStartDay + 13);
    for (let d = biweekStartDay; d <= end; d++) res.push(isoForDay(d));
    return res;
  };
  dpAllMonth?.addEventListener("click", () => addRangeToActive(monthIsos()));
  dpWeekRange?.addEventListener("click", () => addRangeToActive(weekIsos()));
  dpBiweekRange?.addEventListener("click", () => addRangeToActive(biweekIsos()));

  // ===== create person row (add modal) =====
  function makeSelectWrapperOpen(wrapper, select){
    wrapper.addEventListener("click", (e) => {
      if (e.target === select) return;
      select.focus();
      if (select.showPicker) select.showPicker();
      else {
        select.dispatchEvent(new MouseEvent("mousedown", { bubbles:true }));
        select.dispatchEvent(new MouseEvent("click", { bubbles:true }));
      }
    });
    wrapper.addEventListener("keydown", (e) => {
      if (e.key === "Enter" || e.key === " ") {
        e.preventDefault();
        select.focus();
        select.click();
      }
    });
  }

  function fillShiftSelect(select, selectedValue, placeholderLabel, disablePlaceholder){
    select.innerHTML = "";
    const chosen = selectedValue || "";
    if (placeholderLabel){
      const opt = document.createElement("option");
      opt.value = "";
      opt.textContent = placeholderLabel;
      if (disablePlaceholder) opt.disabled = true;
      opt.selected = !chosen;
      select.appendChild(opt);
    }
    loadShifts().forEach((shift) => {
      const opt = document.createElement("option");
      opt.value = shift.name;
      opt.textContent = shift.name;
      select.appendChild(opt);
    });
    if (chosen) select.value = chosen;
  }

  function createPersonRow(){
    const row = document.createElement("div");
    row.className = "add-person";

    const left = document.createElement("div");
    left.className = "add-left";

    const nameInput = document.createElement("input");
    nameInput.className = "add-name";
    nameInput.type = "text";
    nameInput.placeholder = "Nom";
    const nameWrap = document.createElement("div");
    nameWrap.className = "name-plus-wrap";
    const plusWrap = document.createElement("div");
    plusWrap.className = "plus-wrap";
    const pickBtn = document.createElement("button");
    pickBtn.className = "name-plus-btn";
    pickBtn.type = "button";
    pickBtn.textContent = "+";
    pickBtn.title = "Choisir un employé";
    pickBtn.setAttribute("aria-label", "Choisir un employé");
    pickBtn.setAttribute("aria-haspopup", "listbox");
    pickBtn.setAttribute("aria-expanded", "false");
    const dropdown = document.createElement("div");
    dropdown.className = "name-dropdown";
    dropdown.setAttribute("role", "listbox");
    dropdown.hidden = true;

    const shiftWrap = document.createElement("div");
    shiftWrap.className = "shift-wrap";
    shiftWrap.tabIndex = 0;

    const shiftSelect = document.createElement("select");
    shiftSelect.className = "shift-select";
    fillShiftSelect(shiftSelect, "", "Shift", true);

    const chev = document.createElement("div");
    chev.className = "chev";
    shiftWrap.append(shiftSelect, chev);

    const timeRow = document.createElement("div");
    timeRow.className = "time-row";

    const start = document.createElement("input");
    start.type = "time";
    start.className = "time-input";
    start.value = "09:00";
    attachTimeAutoAdvance(start);

    const dash = document.createElement("div");
    dash.className = "dash";
    dash.textContent = "–";

    const end = document.createElement("input");
    end.type = "time";
    end.className = "time-input";
    end.value = "13:00";
    attachTimeAutoAdvance(end);

    timeRow.append(start, dash, end);

    shiftSelect.addEventListener("change", () => {
      const defaults = getShiftDefaults();
      const def = defaults[shiftSelect.value];
      if (!def) return;
      start.value = def.start;
      end.value = def.end;
    });

    makeSelectWrapperOpen(shiftWrap, shiftSelect);
    chev.addEventListener("click", (e) => {
      e.preventDefault();
      e.stopPropagation();
      if (shiftSelect.showPicker) shiftSelect.showPicker();
      else shiftSelect.dispatchEvent(new MouseEvent("click", { bubbles:true }));
    });

    const fillDropdown = () => {
      dropdown.innerHTML = "";
      const list = loadEmployees();
      if (!list.length){
        const empty = document.createElement("div");
        empty.className = "name-empty";
        empty.textContent = "Aucun employé.";
        dropdown.appendChild(empty);
        return;
      }
      list.forEach((emp) => {
        const opt = document.createElement("button");
        opt.type = "button";
        opt.className = "name-option";
        opt.textContent = employeeFullName(emp);
        opt.addEventListener("click", () => {
          nameInput.value = employeeFullName(emp);
          closeNameDropdowns();
        });
        dropdown.appendChild(opt);
      });
    };
    pickBtn.addEventListener("click", (e) => {
      e.preventDefault();
      e.stopPropagation();
      const wasOpen = !dropdown.hidden;
      closeNameDropdowns();
      if (wasOpen) {
        pickBtn.setAttribute("aria-expanded", "false");
        return;
      }
      fillDropdown();
      dropdown.hidden = false;
      pickBtn.setAttribute("aria-expanded", "true");
    });
    plusWrap.append(pickBtn, dropdown);
    nameWrap.append(nameInput, plusWrap);
    left.append(nameWrap, shiftWrap, timeRow);

    const right = document.createElement("div");
    right.className = "add-right";

    const datesWrap = document.createElement("div");
    datesWrap.className = "row-dates";
    const rowDates = new Set();
    if (addBaseIso) rowDates.add(addBaseIso);

    const rowCalendar = document.createElement("button");
    rowCalendar.className = "icon-btn calendar-btn";
    rowCalendar.type = "button";
    rowCalendar.innerHTML = CAL_SVG;
    rowCalendar.title = "Choisir des dates";

    const rowChipBox = document.createElement("div");
    rowChipBox.className = "row-chips";
    renderDateChipsFor(rowDates, rowChipBox);

    rowCalendar.addEventListener("click", () => openDpFor(rowDates, rowChipBox));
    datesWrap.append(rowCalendar, rowChipBox);

    const removeBtn = document.createElement("button");
    removeBtn.className = "btn danger";
    removeBtn.type = "button";
    removeBtn.textContent = "Supprimer";
    removeBtn.addEventListener("click", () => {
      if (addRows.querySelectorAll(".add-person").length <= 1) {
        nameInput.value = "";
        shiftSelect.value = "";
        start.value = "09:00";
        end.value = "13:00";
        return;
      }
      row.remove();
    });

    right.append(datesWrap, removeBtn);
    row.append(left, right);

    row.__getData = () => ({
      name: (nameInput.value || "").trim(),
      shift: shiftSelect.value || "",
      start: start.value || "",
      end: end.value || "",
      dates: Array.from(rowDates)
    });

    setTimeout(() => nameInput.focus(), 0);

    return row;
  }

  addRowBtn.addEventListener("click", () => {
    addRows.appendChild(createPersonRow());
  });

  // ✅ FIX: Valider doit toujours fermer la fenêtre (même si erreur)
  validateAdd.addEventListener("click", () => {
    try{
      const rows = Array.from(addRows.querySelectorAll(".add-person"));
      const people = rows.map(r => r.__getData()).filter(p => p.name);

      if (!people.length){
        return;
      }

      people.forEach((p) => {
        const targetDates = p.dates && p.dates.length ? p.dates : (addBaseIso ? [addBaseIso] : []);
        const entry = makeEntry({ name: p.name, shift: p.shift, start: p.start, end: p.end });
        targetDates.forEach((iso) => {
          const list = getNormalizedList(iso);
          list.push({ ...entry });
          namesByDate.set(iso, list);
          renderInitials(iso);
        });
      });
    } catch(err){
      console.error("Erreur Valider:", err);
    } finally {
      // fermeture quoi qu’il arrive
      closeAddModal();
    }
  });

  // ===== Hook “+” click =====
  function handleAddClick(event){
    const button = event.target.closest(".add-btn");
    if (!button) return;
    const cell = button.closest(".date");
    if (!cell) return;
    const iso = cell.dataset.iso;
    openAddModal(iso);
  }
  grids.forEach(g => g.addEventListener("click", handleAddClick));

  // ===== Click day to open list =====
  function handleDateClick(event){
    if (event.target.closest(".add-btn")) return;
    const cell = event.target.closest(".date");
    if (!cell) return;
    const iso = cell.dataset.iso;
    const day = cell.querySelector(".day-number")?.textContent || "";
    const existing = getNormalizedList(iso);
    if (!existing.length) return;
    openModal(iso, day);
  }
  grids.forEach(g => g.addEventListener("click", handleDateClick));

  // Close add/dp with ESC too
  document.addEventListener("keydown", (e) => {
    if (e.key === "Escape"){
      closeDp();
      closeAddModal();
      closeSummary();
      closeEmployees();
      closeNameDropdowns();
    }
  });

  document.addEventListener("click", (e) => {
    if (!e.target.closest(".plus-wrap")) closeNameDropdowns();
  });

  // ===== Modal list rendering =====
  function renderModalList(iso){
    nameList.innerHTML = "";
    const list = getNormalizedList(iso);
    if (!list.length){
      const empty = document.createElement("div");
      empty.className = "empty-note";
      empty.textContent = "Aucun nom pour cette date.";
      nameList.appendChild(empty);
      return;
    }

    list.forEach((entry) => {
      const row = document.createElement("div");
      row.className = "name-row";

      const compact = document.createElement("div");
      compact.className = "name-text";

      // ✅ COMPACT VIEW: nom uniquement (les dates sont dans les bulles)
      compact.textContent = (entry.name || "").trim() || "Sans nom";

      const delBtn = document.createElement("button");
      delBtn.className = "delete-btn";
      delBtn.type = "button";
      delBtn.title = "Supprimer";
      delBtn.innerHTML = "&#128465;";

      delBtn.addEventListener("click", () => {
        if (!window.confirm("Supprimer cet employé sur toutes ses dates ?")) return;
        removeEntryEverywhere(entry);
        renderModalList(iso);
      });

      const iconWrap = document.createElement("div");
      iconWrap.className = "icon-actions";
      iconWrap.append(delBtn);

      const header = document.createElement("div");
      header.className = "name-header";
      header.append(compact, iconWrap);

      // --- Edit form (détails seulement ici) ---
      const form = document.createElement("div");
      form.className = "edit-form";
      form.hidden = true;

      const nameInput = document.createElement("input");
      nameInput.className = "modal-input";
      nameInput.type = "text";
      nameInput.value = entry.name || "";

      const editGrid = document.createElement("div");
      editGrid.className = "edit-grid";

      const shiftSelect = document.createElement("select");
      shiftSelect.className = "modal-select";
      fillShiftSelect(shiftSelect, entry.shift || "", "Shift (optionnel)", false);

      const startInput = document.createElement("input");
      startInput.type = "time";
      startInput.className = "modal-input";
      const editDefaults = getShiftDefaults();
      startInput.value = entry.start || editDefaults[entry.shift]?.start || "09:00";
      attachTimeAutoAdvance(startInput);

      const endInput = document.createElement("input");
      endInput.type = "time";
      endInput.className = "modal-input";
      endInput.value = entry.end || editDefaults[entry.shift]?.end || "13:00";
      attachTimeAutoAdvance(endInput);

      shiftSelect.addEventListener("change", () => {
        const defaults = getShiftDefaults();
        const def = defaults[shiftSelect.value];
        if (def){
          startInput.value = def.start;
          endInput.value = def.end;
        }
      });

      editGrid.append(shiftSelect, startInput, endInput);

      const entryDatesArr = datesForEntry(entry);
      const entryDates = new Set(entryDatesArr);
      if (!entryDates.size) entryDates.add(iso);

      const dateWrap = document.createElement("div");
      dateWrap.className = "row-dates";

      const dateBtn = document.createElement("button");
      dateBtn.type = "button";
      dateBtn.className = "icon-btn calendar-btn";
      dateBtn.innerHTML = CAL_SVG;
      dateBtn.title = "Choisir les dates";

      const dateChips = document.createElement("div");
      dateChips.className = "row-chips";
      renderDateChipsFor(entryDates, dateChips);

      dateBtn.addEventListener("click", () => openDpFor(entryDates, dateChips));
      dateWrap.append(dateBtn, dateChips);

      const actions = document.createElement("div");
      actions.className = "edit-actions";

      const cancelBtn = document.createElement("button");
      cancelBtn.className = "btn";
      cancelBtn.type = "button";
      cancelBtn.textContent = "Annuler";

      const saveBtn = document.createElement("button");
      saveBtn.className = "btn primary";
      saveBtn.type = "button";
      saveBtn.textContent = "Enregistrer";

      actions.append(cancelBtn, saveBtn);

      form.append(nameInput, editGrid, dateWrap, actions);

      function toggleEdit(on){
        row.classList.toggle("editing", on);
        form.hidden = !on;
        header.hidden = on;
        if (on) setTimeout(() => nameInput.focus(), 0);
      }


      cancelBtn.addEventListener("click", () => {
        nameInput.value = entry.name || "";
        shiftSelect.value = entry.shift || "";
        const defaults = getShiftDefaults();
        startInput.value = entry.start || defaults[entry.shift]?.start || "09:00";
        endInput.value = entry.end || defaults[entry.shift]?.end || "13:00";
        entryDates.clear();
        datesForEntry(entry).forEach((d) => entryDates.add(d));
        if (!entryDates.size) entryDates.add(iso);
        renderDateChipsFor(entryDates, dateChips);
        toggleEdit(false);
      });

      // ✅ FIX: Enregistrer fonctionne + referme l’édition
      saveBtn.addEventListener("click", () => {
        const newName = nameInput.value.trim();
        if (!newName){
          window.alert("Le nom est obligatoire.");
          return;
        }

        const updated = {
          id: entry.id || genEntryId(),
          name: newName,
          shift: shiftSelect.value,
          start: startInput.value || "",
          end: endInput.value || ""
        };

        const selected = entryDates.size ? Array.from(entryDates) : [iso];
        applyEntryChanges(updated, selected);

        // refresh compact line & list
        renderModalList(iso);
        closeModal();
      });

      row.append(header, form);
      nameList.appendChild(row);
    });
  }

  // ===== Employee directory =====
  const EMP_KEY = "employees-dir";
  let employeeView = "add"; // add | list | pick
  let employeePickTarget = null;
  const loadEmployees = () => {
    try {
      const raw = localStorage.getItem(EMP_KEY);
      return raw ? JSON.parse(raw) : [];
    } catch(err){
      console.error("Erreur chargement employés:", err);
      return [];
    }
  };
  const saveEmployees = (list) => {
    try { localStorage.setItem(EMP_KEY, JSON.stringify(list || [])); }
    catch(err){ console.error("Erreur sauvegarde employés:", err); }
  };
  const empId = () => `emp-${Date.now()}-${Math.random().toString(16).slice(2,8)}`;
  const formatBirth = (val) => {
    if (!val || typeof val !== "string") return "";
    const parts = val.split("-");
    if (parts.length !== 3) return val;
    return `${parts[2]}/${parts[1]}/${parts[0]}`;
  };
  const employeeFullName = (emp) => {
    const first = (emp.firstname || "").trim();
    const last = (emp.lastname || "").trim();
    return `${first} ${last}`.trim() || "Sans nom";
  };
  const parseThValue = (val) => {
    if (!val && val !== 0) return null;
    const str = String(val).replace(",", ".").trim();
    const match = str.match(/-?\d+(\.\d+)?/);
    if (!match) return null;
    const num = parseFloat(match[0]);
    return Number.isFinite(num) ? num : null;
  };
  const buildThMap = () => {
    const map = new Map();
    loadEmployees().forEach((emp) => {
      const full = employeeFullName(emp);
      const key = entryKey({ name: full });
      const th = parseThValue(emp.th);
      if (key && th !== null) map.set(key, th);
    });
    return map;
  };
  const renderEmployees = () => {
    if (!employeeList) return;
    employeeList.innerHTML = "";
    const list = loadEmployees();
    if (employeeView === "add") {
      return;
    }
    if (!list.length){
      const empty = document.createElement("div");
      empty.className = "employee-empty";
      empty.textContent = "Aucun employé enregistré.";
      employeeList.appendChild(empty);
      return;
    }
    list.forEach((emp) => {
      const card = document.createElement("div");
      card.className = "employee-card";

      const title = document.createElement("div");
      title.className = "employee-title";
      const nameSpan = document.createElement("span");
      nameSpan.textContent = employeeFullName(emp);
      if (employeeView === "pick" && employeePickTarget){
        const addBtn = document.createElement("button");
        addBtn.className = "employee-delete";
        addBtn.type = "button";
        addBtn.textContent = "Ajouter";
        addBtn.addEventListener("click", () => {
          if (employeePickTarget) employeePickTarget.value = employeeFullName(emp);
          closeEmployees();
        });
        title.append(nameSpan, addBtn);
      } else {
        const del = document.createElement("button");
        del.className = "employee-delete";
        del.type = "button";
        del.textContent = "Supprimer";
        del.addEventListener("click", () => {
          const next = loadEmployees().filter((e) => e.id !== emp.id);
          saveEmployees(next);
          renderEmployees();
        });
        title.append(nameSpan, del);
      }

      const meta = document.createElement("div");
      meta.className = "employee-meta";
      const lines = [];
      if (emp.birth) lines.push(`Naissance: ${formatBirth(emp.birth)}`);
      if (emp.address) lines.push(`Adresse: ${emp.address}`);
      if (emp.phone) lines.push(`Tel: ${emp.phone}`);
      if (emp.th) lines.push(`T H: ${emp.th}`);
      if (emp.pro) lines.push(`Situation Pro: ${emp.pro}`);
      if (emp.perso) lines.push(`Situation Perso: ${emp.perso}`);
      meta.textContent = lines.join(" | ");

      card.append(title, meta);
      employeeList.appendChild(card);
    });
  };
  const setEmployeeFormEnabled = (enabled) => {
    if (!employeeForm) return;
    const fields = employeeForm.querySelectorAll("input, textarea, button");
    fields.forEach((el) => { el.disabled = !enabled; });
  };

  const openEmployees = (mode = "add", target = null) => {
    if (mode === "pick" && target){
      employeeView = "pick";
      employeePickTarget = target;
    } else if (mode === "list") {
      employeeView = "list";
      employeePickTarget = null;
    } else {
      employeeView = "add";
      employeePickTarget = null;
    }
    if (employeeTitle) {
      if (employeeView === "list") employeeTitle.textContent = "Équipe";
      else if (employeeView === "pick") employeeTitle.textContent = "Choisir un employé";
      else employeeTitle.textContent = "Ajouter un employé";
    }
    if (employeeForm) employeeForm.hidden = employeeView !== "add";
    setEmployeeFormEnabled(employeeView === "add");
    if (employeeForm && employeeView !== "add") employeeForm.style.display = "none";
    if (employeeForm && employeeView === "add") employeeForm.style.display = "";
    renderEmployees();
    if (employeeOverlay){
      employeeOverlay.style.display = "flex";
      employeeOverlay.setAttribute("aria-hidden","false");
    }
  };
  const closeEmployees = () => {
    if (!employeeOverlay) return;
    employeeOverlay.style.display = "none";
    employeeOverlay.setAttribute("aria-hidden","true");
    employeeView = "add";
    employeePickTarget = null;
    if (employeeForm) employeeForm.hidden = false;
    setEmployeeFormEnabled(true);
    if (employeeForm) employeeForm.style.display = "";
  };
  if (teamBtn) teamBtn.addEventListener("click", () => openEmployees("list"));
  if (employeeBtn) employeeBtn.addEventListener("click", () => openEmployees("add"));
  if (employeeClose) employeeClose.addEventListener("click", closeEmployees);
  if (employeeOverlay) employeeOverlay.addEventListener("click", (e) => { if (e.target === employeeOverlay) closeEmployees(); });
  if (employeeForm) employeeForm.addEventListener("submit", (e) => {
    e.preventDefault();
    if (employeeView === "list") return;
    const lastname = (empLastname?.value || "").trim();
    const firstname = (empFirstname?.value || "").trim();
    if (!lastname && !firstname){
      window.alert("Nom ou prénom obligatoire.");
      return;
    }
    const emp = {
      id: empId(),
      lastname,
      firstname,
      birth: (empBirth?.value || "").trim(),
      address: (empAddress?.value || "").trim(),
      phone: (empPhone?.value || "").trim(),
      th: (empTh?.value || "").trim(),
      pro: (empPro?.value || "").trim(),
      perso: (empPerso?.value || "").trim()
    };
    const list = loadEmployees();
    list.push(emp);
    saveEmployees(list);
    if (employeeForm) employeeForm.reset();
    if (empLastname) empLastname.focus();
    renderEmployees();
    closeEmployees();
  });

  // ===== Shift management =====
  const refreshShiftSelects = (renameMap = null) => {
    const rename = renameMap || {};
    document.querySelectorAll("select.shift-select").forEach((select) => {
      const current = rename[select.value] || select.value;
      fillShiftSelect(select, current, "Shift", true);
    });
    document.querySelectorAll("select.modal-select").forEach((select) => {
      const current = rename[select.value] || select.value;
      fillShiftSelect(select, current, "Shift (optionnel)", false);
    });
  };

  const updateEntriesShiftName = (from, to) => {
    if (!from || !to || from === to) return;
    namesByDate.forEach((list, iso) => {
      const normalized = getNormalizedList(iso);
      let changed = false;
      normalized.forEach((entry) => {
        if (entry.shift === from){
          entry.shift = to;
          changed = true;
        }
      });
      if (changed) namesByDate.set(iso, normalized);
    });
  };
  const clearEntriesShiftName = (name) => {
    if (!name) return;
    namesByDate.forEach((list, iso) => {
      const normalized = getNormalizedList(iso);
      let changed = false;
      normalized.forEach((entry) => {
        if (entry.shift === name){
          entry.shift = "";
          changed = true;
        }
      });
      if (changed) namesByDate.set(iso, normalized);
    });
  };

  const renderShifts = () => {
    if (!shiftList) return;
    shiftList.innerHTML = "";
    const list = loadShifts();
    if (!list.length){
      const empty = document.createElement("div");
      empty.className = "shift-empty";
      empty.textContent = "Aucun shift enregistré.";
      shiftList.appendChild(empty);
      return;
    }
    list.forEach((shift) => {
      const row = document.createElement("div");
      row.className = "shift-row";

      const grid = document.createElement("div");
      grid.className = "shift-grid";

      const nameInput = document.createElement("input");
      nameInput.className = "modal-input";
      nameInput.type = "text";
      nameInput.value = shift.name;
      nameInput.setAttribute("aria-label", "Nom du shift");

      const startInput = document.createElement("input");
      startInput.className = "modal-input";
      startInput.type = "time";
      startInput.value = shift.start || "";
      startInput.setAttribute("aria-label", "Début");
      attachTimeAutoAdvance(startInput);

      const endInput = document.createElement("input");
      endInput.className = "modal-input";
      endInput.type = "time";
      endInput.value = shift.end || "";
      endInput.setAttribute("aria-label", "Fin");
      attachTimeAutoAdvance(endInput);

      grid.append(nameInput, startInput, endInput);

      const actions = document.createElement("div");
      actions.className = "shift-actions";

      const saveBtn = document.createElement("button");
      saveBtn.className = "btn primary";
      saveBtn.type = "button";
      saveBtn.textContent = "Enregistrer";
      saveBtn.addEventListener("click", () => {
        const newName = nameInput.value.trim();
        if (!newName){
          window.alert("Le nom du shift est obligatoire.");
          return;
        }
        if (isShiftNameTaken(newName, shift.id)){
          window.alert("Ce nom de shift existe déjà.");
          return;
        }
        const listNow = loadShifts();
        const idx = listNow.findIndex((s) => s.id === shift.id);
        if (idx === -1) return;
        const oldName = listNow[idx].name;
        listNow[idx] = {
          ...listNow[idx],
          name: newName,
          start: startInput.value || "",
          end: endInput.value || ""
        };
        saveShifts(listNow);
        if (oldName !== newName){
          updateEntriesShiftName(oldName, newName);
          refreshShiftSelects({ [oldName]: newName });
        } else {
          refreshShiftSelects();
        }
        if (overlay?.dataset?.iso) renderModalList(overlay.dataset.iso);
        renderShifts();
      });

      const deleteBtn = document.createElement("button");
      deleteBtn.className = "btn danger";
      deleteBtn.type = "button";
      deleteBtn.textContent = "Supprimer";
      deleteBtn.addEventListener("click", () => {
        const ok = window.confirm("Supprimer ce shift ? Les entrées l'utilisant seront retirées du shift.");
        if (!ok) return;
        const listNow = loadShifts().filter((s) => s.id !== shift.id);
        saveShifts(listNow);
        clearEntriesShiftName(shift.name);
        refreshShiftSelects();
        if (overlay?.dataset?.iso) renderModalList(overlay.dataset.iso);
        renderShifts();
      });

      actions.append(saveBtn, deleteBtn);
      row.append(grid, actions);
      shiftList.appendChild(row);
    });
  };

  const openShifts = () => {
    renderShifts();
    if (shiftOverlay){
      shiftOverlay.style.display = "flex";
      shiftOverlay.setAttribute("aria-hidden","false");
      if (shiftNewName) shiftNewName.focus();
    }
  };
  const closeShifts = () => {
    if (!shiftOverlay) return;
    shiftOverlay.style.display = "none";
    shiftOverlay.setAttribute("aria-hidden","true");
  };

  if (shiftBtn) shiftBtn.addEventListener("click", openShifts);
  if (shiftClose) shiftClose.addEventListener("click", closeShifts);
  if (shiftOverlay) shiftOverlay.addEventListener("click", (e) => { if (e.target === shiftOverlay) closeShifts(); });

  if (shiftAddBtn) shiftAddBtn.addEventListener("click", () => {
    const name = (shiftNewName?.value || "").trim();
    if (!name){
      window.alert("Le nom du shift est obligatoire.");
      return;
    }
    if (isShiftNameTaken(name)){
      window.alert("Ce nom de shift existe déjà.");
      return;
    }
    const listNow = loadShifts();
    listNow.push({
      id: shiftId(),
      name,
      start: (shiftNewStart?.value || "").trim(),
      end: (shiftNewEnd?.value || "").trim()
    });
    saveShifts(listNow);
    if (shiftNewName) shiftNewName.value = "";
    if (shiftNewStart) shiftNewStart.value = "";
    if (shiftNewEnd) shiftNewEnd.value = "";
    renderShifts();
    refreshShiftSelects();
  });
  if (shiftNewStart) attachTimeAutoAdvance(shiftNewStart);
  if (shiftNewEnd) attachTimeAutoAdvance(shiftNewEnd);

  // ===== Summary hours =====
  function buildSummaryRows(){
    const active = activeIsosForPrint();
    const totals = new Map();
    const thMap = buildThMap();
    namesByDate.forEach((list, iso) => {
      if (active && !active.has(iso)) return;
      const entries = getNormalizedList(iso);
      entries.forEach((entry) => {
        const key = entryKey(entry);
        if (!key) return;
        const existing = totals.get(key) || { name: (entry.name || "").trim(), minutes: 0 };
        existing.minutes += entryMinutes(entry);
        if (!existing.name && entry.name) existing.name = entry.name.trim();
        existing.th = thMap.get(key) ?? null;
        totals.set(key, existing);
      });
    });
    return Array.from(totals.values())
      .filter(r => r.name)
      .sort((a,b) => a.name.localeCompare(b.name));
  }

  function renderSummary(){
    if (!summaryBody) return;
    summaryBody.innerHTML = "";
    const rows = buildSummaryRows();
    if (!rows.length){
      const tr = document.createElement("tr");
      const td = document.createElement("td");
      td.colSpan = 3;
      td.className = "summary-empty";
      td.textContent = "Aucune donnée.";
      tr.appendChild(td);
      summaryBody.appendChild(tr);
      return;
    }
    rows.forEach((row) => {
      const tr = document.createElement("tr");
      const tdName = document.createElement("td");
      tdName.textContent = row.name;
      const tdHours = document.createElement("td");
      tdHours.textContent = formatMinutes(row.minutes);
      const tdTotal = document.createElement("td");
      const hoursDecimal = row.minutes / 60;
      const total = row.th !== null ? hoursDecimal * row.th : null;
      tdTotal.textContent = formatNumber(total);
      tr.append(tdName, tdHours, tdTotal);
      summaryBody.appendChild(tr);
    });
  }

  function openSummary(){
    renderSummary();
    if (summaryOverlay){
      summaryOverlay.style.display = "flex";
      summaryOverlay.setAttribute("aria-hidden","false");
    }
  }
  function closeSummary(){
    if (!summaryOverlay) return;
    summaryOverlay.style.display = "none";
    summaryOverlay.setAttribute("aria-hidden","true");
  }
  if (summaryBtn) summaryBtn.addEventListener("click", openSummary);
  if (summaryClose) summaryClose.addEventListener("click", closeSummary);
  if (summaryOverlay) summaryOverlay.addEventListener("click", (e) => { if (e.target === summaryOverlay) closeSummary(); });

  // ===== Print view =====
  function activeIsosForPrint(){
    computeMonthMeta();
    if (currentView === "week"){
      const maxStart = Math.max(1, daysInMonth - 6);
      const start = Math.min(Math.max(1, weekStartDay), maxStart);
      const end = Math.min(daysInMonth, start + 6);
      const set = new Set();
      for (let d = start; d <= end; d++) set.add(isoForDay(d));
      return set;
    }
    if (currentView === "biweek"){
      const maxStart = Math.max(1, daysInMonth - 13);
      const start = Math.min(Math.max(1, biweekStartDay), maxStart);
      const end = Math.min(daysInMonth, start + 13);
      const set = new Set();
      for (let d = start; d <= end; d++) set.add(isoForDay(d));
      return set;
    }
    if (currentView === "month"){
      computeMonthMeta();
      const set = new Set();
      for (let d = 1; d <= daysInMonth; d++) set.add(isoForDay(d));
      return set;
    }
    return null; // fallback: all
  }

  const csvEscape = (value) => {
    if (value === null || value === undefined) return "";
    const str = String(value);
    return /[\";\n\r]/.test(str) ? `"${str.replace(/\"/g, '""')}"` : str;
  };

  function buildExportRows(){
    const rows = [];
    const active = activeIsosForPrint();
    const thMap = buildThMap();
    const defaults = getShiftDefaults();
    const isoList = Array.from(namesByDate.keys())
      .filter((iso) => !active || active.has(iso))
      .sort();

    isoList.forEach((iso) => {
      const entries = getNormalizedList(iso);
      if (!entries.length) return;
      const sorted = [...entries].sort((a,b) => entryKey(a).localeCompare(entryKey(b)));
      sorted.forEach((entry) => {
        const name = (entry.name || "").trim() || "Sans nom";
        const shift = entry.shift || "";
        const startVal = entry.start || defaults[shift]?.start || "";
        const endVal = entry.end || defaults[shift]?.end || "";
        const minutes = entryMinutes(entry);
        const hoursDecimal = minutes / 60;
        const th = thMap.get(entryKey(entry)) ?? null;
        const total = th !== null ? hoursDecimal * th : null;
        rows.push({
          iso,
          date: fmtExportDate(iso),
          weekday: fmtExportWeekday(iso),
          name,
          shift: shift || "—",
          start: startVal,
          end: endVal,
          hours: formatNumber(hoursDecimal),
          hoursValue: hoursDecimal,
          th: th !== null ? formatNumber(th) : "",
          total: total !== null ? formatNumber(total) : "",
          totalValue: total !== null ? total : 0
        });
      });
    });
    rows.sort((a,b) => a.iso === b.iso ? a.name.localeCompare(b.name) : a.iso.localeCompare(b.iso));
    return rows;
  }

  function exportFilename(){
    computeMonthMeta();
    const month = pad(currentMonth + 1);
    if (currentView === "week"){
      const end = Math.min(daysInMonth, weekStartDay + 6);
      return `planning-${currentYear}-${month}-semaine-${pad(weekStartDay)}-${pad(end)}.csv`;
    }
    if (currentView === "biweek"){
      const end = Math.min(daysInMonth, biweekStartDay + 13);
      return `planning-${currentYear}-${month}-semaines-${pad(biweekStartDay)}-${pad(end)}.csv`;
    }
    return `planning-${currentYear}-${month}.csv`;
  }

  function buildExportCsv(rows){
    const headers = ["Date","Jour","Nom","Shift","Heure debut","Heure fin","Duree (h)","T H","Total"];
    const lines = [headers.map(csvEscape).join(";")];
    let sumHours = 0;
    let sumTotal = 0;
    rows.forEach((row) => {
      sumHours += row.hoursValue || 0;
      sumTotal += row.totalValue || 0;
      const values = [
        row.date,
        row.weekday,
        row.name,
        row.shift,
        row.start,
        row.end,
        row.hours,
        row.th,
        row.total
      ];
      lines.push(values.map(csvEscape).join(";"));
    });
    const totalRow = [
      "",
      "",
      "TOTAL",
      "",
      "",
      "",
      formatNumber(sumHours),
      "",
      formatNumber(sumTotal)
    ];
    lines.push(totalRow.map(csvEscape).join(";"));
    return `\ufeff${lines.join("\n")}`;
  }

  function exportCsv(){
    const rows = buildExportRows();
    if (!rows.length){
      window.alert("Aucune donnée à exporter.");
      return;
    }
    const csv = buildExportCsv(rows);
    const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
    const url = URL.createObjectURL(blob);
    const link = document.createElement("a");
    link.href = url;
    link.download = exportFilename();
    document.body.appendChild(link);
    link.click();
    link.remove();
    setTimeout(() => URL.revokeObjectURL(url), 200);
  }

  function resetLabelForView(){
    computeMonthMeta();
    if (currentView === "week"){
      const maxStart = Math.max(1, daysInMonth - 6);
      const start = Math.min(Math.max(1, weekStartDay), maxStart);
      const end = Math.min(daysInMonth, start + 6);
      return `la semaine du ${pad(start)} au ${pad(end)} ${monthLabelShort(currentMonth)} ${currentYear}`;
    }
    if (currentView === "biweek"){
      const maxStart = Math.max(1, daysInMonth - 13);
      const start = Math.min(Math.max(1, biweekStartDay), maxStart);
      const end = Math.min(daysInMonth, start + 13);
      return `les semaines du ${pad(start)} au ${pad(end)} ${monthLabelShort(currentMonth)} ${currentYear}`;
    }
    return `le mois ${monthLabel(currentYear, currentMonth)}`;
  }

  function resetCurrentPeriod(){
    const active = activeIsosForPrint();
    if (!active || !active.size){
      window.alert("Aucune période active à réinitialiser.");
      return;
    }
    const label = resetLabelForView();
    const ok = window.confirm(`Tout effacer pour ${label} ? Cette action est définitive.`);
    if (!ok) return;
    active.forEach((iso) => {
      if (namesByDate.has(iso)) namesByDate.set(iso, []);
      renderInitials(iso);
    });
    if (summaryOverlay && summaryOverlay.style.display === "flex") renderSummary();
  }

  function printRangeLabel(){
    computeMonthMeta();
    if (currentView === "week"){
      const end = Math.min(daysInMonth, weekStartDay + 6);
      return `Semaine du ${pad(weekStartDay)} au ${pad(end)} ${monthLabelShort(currentMonth)} ${currentYear}`;
    }
    if (currentView === "biweek"){
      const end = Math.min(daysInMonth, biweekStartDay + 13);
      return `semaines du ${pad(biweekStartDay)} au ${pad(end)} ${monthLabelShort(currentMonth)} ${currentYear}`;
    }
    return `Mois complet (${monthLabel(currentYear, currentMonth)})`;
  }

  function buildPrintRows(){
    const rows = [];
    const active = activeIsosForPrint();
    const isoList = Array.from(namesByDate.keys())
      .filter((iso) => !active || active.has(iso))
      .sort();
    isoList.forEach((iso) => {
      const entries = getNormalizedList(iso);
      if (!entries.length) return;
      const sorted = [...entries].sort((a,b) => entryKey(a).localeCompare(entryKey(b)));
      sorted.forEach((entry) => {
        const name = (entry.name || "").trim() || "Sans nom";
        const shift = entry.shift || "—";
        const slot = (entry.start || entry.end) ? `${entry.start || ""}${entry.end ? `–${entry.end}` : ""}` : "—";
        rows.push({ iso, name, shift, slot, dateLabel: fmtLongFR(iso) });
      });
    });
    rows.sort((a,b) => a.iso === b.iso ? a.name.localeCompare(b.name) : a.iso.localeCompare(b.iso));
    return rows;
  }

  function renderPrintTable(){
    if (!printBody) return;
    const rows = buildPrintRows();
    printBody.innerHTML = "";
    if (!rows.length){
      const tr = document.createElement("tr");
      const td = document.createElement("td");
      td.colSpan = 4;
      td.className = "print-empty";
      td.textContent = "Aucune donnée à imprimer.";
      tr.appendChild(td);
      printBody.appendChild(tr);
      return;
    }

    rows.forEach((r) => {
      const tr = document.createElement("tr");
      const tdDate = document.createElement("td");
      tdDate.textContent = r.dateLabel;
      const tdName = document.createElement("td");
      tdName.textContent = r.name;
      const tdShift = document.createElement("td");
      tdShift.textContent = r.shift || "—";
      const tdHours = document.createElement("td");
      tdHours.textContent = r.slot || "—";
      tr.append(tdDate, tdName, tdShift, tdHours);
      printBody.appendChild(tr);
    });
  }

  function launchPrint(){
    renderPrintTable();
    if (printMeta){
      const now = new Date();
      printMeta.textContent = `${printRangeLabel()} — généré le ${now.toLocaleString("fr-FR")}`;
    }
    if (printTitle){
      const baseLabel = monthLabel(currentYear, currentMonth);
      if (currentView === "week") printTitle.textContent = `Planning (semaine) — ${baseLabel}`;
      else if (currentView === "biweek") printTitle.textContent = `Planning (2 semaines) — ${baseLabel}`;
      else printTitle.textContent = `Planning (mois) — ${baseLabel}`;
    }
    if (printSheet) printSheet.hidden = false;
    document.body.classList.add("printing");
    setTimeout(() => window.print(), 60);
    setTimeout(cleanupPrint, 1200);
  }

  function cleanupPrint(){
    document.body.classList.remove("printing");
    if (printSheet) printSheet.hidden = true;
  }
  window.addEventListener("afterprint", cleanupPrint);
  if (printBtn) printBtn.addEventListener("click", launchPrint);
  if (exportBtn) exportBtn.addEventListener("click", exportCsv);
  if (resetBtn) resetBtn.addEventListener("click", resetCurrentPeriod);
</script>
</body>
</html>
